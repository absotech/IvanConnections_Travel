<?xml version="1.0" encoding="utf-8" ?>
<toolkit:Popup xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
               xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
               xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
               xmlns:vm="clr-namespace:IvanConnections_Travel.ViewModels.Popups"
               xmlns:model="clr-namespace:IvanConnections_Travel.Models"
               xmlns:converters="clr-namespace:IvanConnections_Travel.Converters"
               CanBeDismissedByTappingOutsideOfPopup="True"
               x:DataType="vm:StopPopupViewModel"
               Color="Transparent"
               x:Class="IvanConnections_Travel.Views.Popups.StopPopup">
    <toolkit:Popup.Resources>
        <converters:VehicleTypeToStringConverter x:Key="VehicleTypeConverter" />
        <converters:ArrivalTimeConverter x:Key="ArrivalTimeConverter" />
    </toolkit:Popup.Resources>
    <Border Stroke="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
            StrokeThickness="2"
            BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource OffBlack}}"
            MinimumWidthRequest="300"
            Padding="20">
        <Border.StrokeShape>
            <RoundRectangle CornerRadius="20" />
        </Border.StrokeShape>

        <VerticalStackLayout Spacing="15">
            <Label Text="{Binding Stop.StopName}"
                   FontSize="22"
                   FontAttributes="Bold"
                   HorizontalOptions="Center" />

            <ActivityIndicator IsRunning="{Binding IsLoading}"
                               IsVisible="{Binding IsLoading}"
                               HorizontalOptions="Center" />

            <CollectionView ItemsSource="{Binding Arrivals}"
                            IsVisible="{Binding IsLoading, Converter={toolkit:InvertedBoolConverter}}">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="model:StopArrival">
                        <Grid Padding="0, 5"
                              ColumnDefinitions="*, Auto">
                            <Label Grid.Column="0"
                                   FontSize="16">
                                <Label.FormattedText>
                                    <FormattedString>
                                        <Span Text="{Binding VehicleType, Converter={StaticResource VehicleTypeConverter}}" />
                                        <Span Text="{Binding VehicleLabel}"
                                              FontAttributes="Bold" />
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>
                            <Label Grid.Column="1"
                                   Text="{Binding ArrivalTimeInMinutes, Converter={StaticResource ArrivalTimeConverter}}"
                                   FontAttributes="Bold"
                                   FontSize="16" />
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <Label Text="{Binding ErrorMessage}"
                   IsVisible="{Binding ErrorMessage, Converter={toolkit:IsStringNotNullOrEmptyConverter}}"
                   HorizontalOptions="Center"
                   TextColor="Gray" />

            <Button Text="ÃŽnchide"
                    Margin="0,10,0,0"
                    Clicked="CloseButton_Clicked" />

        </VerticalStackLayout>
    </Border>
</toolkit:Popup>